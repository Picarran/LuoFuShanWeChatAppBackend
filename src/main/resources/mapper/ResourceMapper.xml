<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.luofushan.dao.mapper.ResourceMapper">

    <select id="selectResourcePage" resultType="com.example.luofushan.dto.resp.ResourcePageResp">
        SELECT
        id,
        type,
        name,
        cover_img AS coverImg,
        hot_score AS hotScore,
        latitude,
        longitude,
        created_at AS createdAt
        FROM resource
        WHERE delflag = 0
        <if test="type != null and type != 'ALL'">
            AND type = #{type}
        </if>
        <if test="fuzzy != null and fuzzy != ''">
            AND name LIKE CONCAT('%', #{fuzzy}, '%')
        </if>
        <choose>
            <when test="sortBy == 'distance'">
                <!-- distance 排序在前端或 SQL 加入计算字段，如果有用户经纬度 -->
                ORDER BY latitude, longitude
            </when>
            <when test="sortBy == 'hot'">
                ORDER BY hot_score DESC
            </when>
            <otherwise>
                ORDER BY created_at DESC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{size}
    </select>

    <select id="countResource" resultType="int">
        SELECT COUNT(*)
        FROM resource
        WHERE delflag = 0
        <if test="type != null and type != 'ALL'">
            AND type = #{type}
        </if>
        <if test="fuzzy != null and fuzzy != ''">
            AND name LIKE CONCAT('%', #{fuzzy}, '%')
        </if>
    </select>

    <!-- 查询附近资源 -->
    <select id="selectNearbyResources" resultType="com.example.luofushan.dto.resp.NearbyResourceResp">
        SELECT
        r.id,
        r.name AS title,
        r.longitude,
        r.latitude,
        IF(
        #{latitude} IS NOT NULL AND #{longitude} IS NOT NULL,
        ST_Distance_Sphere(
        POINT(r.longitude, r.latitude),
        POINT(#{longitude}, #{latitude})
        ),
        NULL
        ) AS distance,
        r.hot_score AS hotScore,
        r.cover_img AS coverImg,
        r.created_at AS createdAt
        FROM resource r
        WHERE r.delflag = 0
        AND r.type = #{type}
        <choose>
            <when test="sortBy == 'distance'">
                ORDER BY distance ASC
            </when>
            <when test="sortBy == 'hot'">
                ORDER BY r.hot_score DESC
            </when>
            <otherwise>
                ORDER BY distance ASC
            </otherwise>
        </choose>
        LIMIT #{offset}, #{size}
    </select>

    <!-- 查询总数 -->
    <select id="countNearbyResources" resultType="int">
        SELECT COUNT(*)
        FROM resource r
        WHERE r.delflag = 0
        AND r.type = #{type}
    </select>

    <select id="selectResourceContent" resultType="com.example.luofushan.dto.resp.NearbyResourceContentResp">
        SELECT
        r.id,
        r.name,
        r.cover_img AS coverImg,
        r.hot_score AS hotScore,
        r.created_at AS createdAt,
        r.content_json AS content,
        r.longitude,
        r.latitude,
        IF(#{userLat} IS NOT NULL AND #{userLng} IS NOT NULL,
        ST_Distance_Sphere(POINT(r.longitude, r.latitude), POINT(#{userLng}, #{userLat})),
        NULL
        ) AS distance
        FROM resource r
        WHERE r.delflag = 0
        AND r.id = #{id}
    </select>

</mapper>
